<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="theme-color" content="#fafafa" />
    <link rel="manifest" href="manifest.json" />
    <title>æ‰‹æ–æ—¥è¨˜</title>
    <style>
      :root {
        --bg: #f2f2f7;
        --card: #fff;
        --text: #1c1c1e;
        --sub: #8e8e93;
        --line: #e5e5ea;
        --brand: #007aff;
        --danger: #ff3b30;
        --radius: 18px;
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        --safe-bottom: env(safe-area-inset-bottom, 20px);
        --safe-top: env(safe-area-inset-top, 20px);
      }
      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
        height: 100vh;
        overflow-y: auto;
      }
      input,
      button {
        font-family: inherit;
      }

      /* Header */
      header {
        position: sticky;
        top: 0;
        z-index: 100;
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        padding: max(12px, var(--safe-top)) 16px 12px;
      }
      .head-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }
      .app-name {
        font-size: 24px;
        font-weight: 800;
        letter-spacing: -0.5px;
      }
      .icon-btn {
        background: none;
        border: none;
        color: var(--brand);
        font-size: 15px;
        font-weight: 600;
        padding: 8px;
        cursor: pointer;
      }

      /* Segment Control */
      .segment {
        background: #e3e3e8;
        padding: 2px;
        border-radius: 10px;
        display: flex;
      }
      .segment button {
        flex: 1;
        border: none;
        background: none;
        padding: 6px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        color: var(--text);
        transition: all 0.2s;
      }
      .segment button.active {
        background: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      /* Main Content */
      .wrap {
        max-width: 600px;
        margin: 0 auto;
        padding: 16px 16px 100px;
      }

      /* Stat Cards */
      .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 24px;
      }
      .stat-card {
        background: var(--card);
        padding: 16px;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
      }
      .stat-label {
        font-size: 13px;
        color: var(--sub);
        font-weight: 600;
        margin-bottom: 4px;
      }
      .stat-val {
        font-size: 26px;
        font-weight: 800;
        letter-spacing: -0.5px;
      }
      .stat-unit {
        font-size: 14px;
        color: var(--sub);
        font-weight: 600;
        margin-left: 2px;
      }

      /* Section Headers */
      h2 {
        font-size: 18px;
        margin: 24px 4px 12px;
        font-weight: 700;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .link-btn {
        font-size: 14px;
        color: var(--brand);
        font-weight: 500;
        cursor: pointer;
      }

      /* List Items */
      .list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .item {
        background: var(--card);
        padding: 16px;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: transform 0.1s;
        cursor: pointer;
      }
      .item:active {
        transform: scale(0.98);
      }
      .item-main {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .item-title {
        font-size: 16px;
        font-weight: 700;
        color: #000;
      }
      .item-sub {
        font-size: 13px;
        color: var(--sub);
      }
      .item-right {
        text-align: right;
      }
      .item-price {
        font-size: 17px;
        font-weight: 700;
        color: var(--text);
      }
      .item-tag {
        display: inline-block;
        background: #f2f2f7;
        color: var(--sub);
        font-size: 11px;
        padding: 2px 6px;
        border-radius: 6px;
        margin-top: 4px;
        font-weight: 600;
      }

      .empty-state {
        text-align: center;
        padding: 40px 0;
        color: var(--sub);
        font-size: 14px;
        border: 2px dashed #e5e5ea;
        border-radius: var(--radius);
      }
      .loading-state {
        text-align: center;
        padding: 20px;
        color: var(--sub);
        font-size: 14px;
      }
      .sync-status {
        position: fixed;
        top: 60px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--card);
        padding: 8px 16px;
        border-radius: 20px;
        box-shadow: var(--shadow);
        font-size: 12px;
        font-weight: 600;
        z-index: 150;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
      }
      .sync-status.show {
        opacity: 1;
      }
      .sync-status.success {
        color: #34c759;
      }
      .sync-status.error {
        color: var(--danger);
      }
      .sync-status.syncing {
        color: var(--brand);
      }
      .offline-banner {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: #ff9500;
        color: #fff;
        text-align: center;
        padding: 8px;
        font-size: 13px;
        font-weight: 600;
        z-index: 200;
        transform: translateY(-100%);
        transition: transform 0.3s;
      }
      .offline-banner.show {
        transform: translateY(0);
      }
      .debug-panel {
        position: fixed;
        bottom: 80px;
        right: 20px;
        background: rgba(0, 0, 0, 0.9);
        color: #0f0;
        padding: 12px;
        border-radius: 8px;
        font-family: monospace;
        font-size: 11px;
        max-width: 400px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 300;
        display: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }
      .debug-panel.show {
        display: block;
      }
      .debug-panel .debug-item {
        margin-bottom: 4px;
        padding: 4px;
        border-bottom: 1px solid #333;
      }
      .debug-panel .debug-label {
        color: #0ff;
        font-weight: bold;
      }
      .debug-panel .debug-value {
        color: #0f0;
      }
      .debug-panel .debug-error {
        color: #f00;
      }

      /* FAB */
      .fab {
        position: fixed;
        bottom: max(20px, var(--safe-bottom));
        right: 20px;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: var(--text);
        color: #fff;
        border: none;
        font-size: 28px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 90;
        transition: transform 0.2s;
      }
      .fab:active {
        transform: scale(0.9);
      }

      /* Modal / Sheet */
      .overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        z-index: 200;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s;
      }
      .overlay.show {
        opacity: 1;
        pointer-events: auto;
      }
      .sheet {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--card);
        border-radius: 24px 24px 0 0;
        z-index: 201;
        padding: 20px 20px max(20px, var(--safe-bottom));
        transform: translateY(100%);
        transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        max-width: 600px;
        margin: 0 auto;
      }
      .sheet.show {
        transform: translateY(0);
      }
      .sheet-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .sheet-title {
        font-size: 20px;
        font-weight: 800;
      }
      .close-btn {
        background: #f2f2f7;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        color: #888;
        font-size: 18px;
      }

      /* Form */
      .form-group {
        margin-bottom: 16px;
      }
      .form-label {
        display: block;
        font-size: 12px;
        font-weight: 700;
        color: var(--sub);
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .form-input {
        width: 100%;
        padding: 14px;
        background: #f2f2f7;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        color: var(--text);
        outline: none;
      }
      .form-input:focus {
        background: #e3e3e8;
      }
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      .btn-submit {
        width: 100%;
        padding: 16px;
        background: var(--brand);
        color: #fff;
        border: none;
        border-radius: 14px;
        font-size: 16px;
        font-weight: 700;
        margin-top: 10px;
        cursor: pointer;
      }
      .btn-submit:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .btn-delete {
        width: 100%;
        padding: 14px;
        background: transparent;
        color: var(--danger);
        border: none;
        font-size: 14px;
        font-weight: 600;
        margin-top: 8px;
        cursor: pointer;
      }

      /* Chips */
      .chips {
        display: flex;
        gap: 8px;
        overflow-x: auto;
        padding-bottom: 4px;
        margin-bottom: 8px;
        -webkit-overflow-scrolling: touch;
      }
      .chip {
        white-space: nowrap;
        padding: 6px 12px;
        background: #f0f0f5;
        border: 1px solid #e0e0e5;
        border-radius: 20px;
        font-size: 13px;
        color: var(--text);
        font-weight: 500;
        flex-shrink: 0;
        cursor: pointer;
      }
      .chip:active {
        background: #e0e0eb;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="head-top">
        <div class="app-name">æ‰‹æ–æ—¥è¨˜</div>
        <div style="display: flex; gap: 8px;">
          <button class="icon-btn" id="btnDebug" onclick="toggleDebug()" style="font-size: 12px;" title="é™¤éŒ¯è³‡è¨Š">
            ğŸ›
          </button>
          <button class="icon-btn" id="btnSync" onclick="syncData()">
            ğŸ”„ åŒæ­¥
          </button>
        </div>
      </div>
      <div class="sync-status" id="syncStatus"></div>
      <div class="offline-banner" id="offlineBanner">
        ğŸ“´ ç›®å‰ç‚ºé›¢ç·šæ¨¡å¼ï¼Œè³‡æ–™å°‡åœ¨é€£ç·šå¾ŒåŒæ­¥
      </div>
      <div class="debug-panel" id="debugPanel">
        <div style="color: #fff; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #555; padding-bottom: 4px;">
          ğŸ› é™¤éŒ¯è³‡è¨Š
        </div>
        <div id="debugContent"></div>
      </div>
      <div class="segment">
        <button class="active" onclick="setRange('week')" id="tab-week">
          æœ¬é€±
        </button>
        <button onclick="setRange('month')" id="tab-month">æœ¬æœˆ</button>
        <button onclick="setRange('all')" id="tab-all">å…¨éƒ¨</button>
      </div>
    </header>

    <main class="wrap">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">ç´¯ç©æ¯æ•¸</div>
          <div class="stat-val">
            <span id="valCups">0</span><span class="stat-unit">æ¯</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ç¸½èŠ±è²»</div>
          <div class="stat-val" style="color: var(--brand)" id="valSpend">
            $0
          </div>
        </div>
      </div>

      <h2>
        åº—å®¶æ’è¡Œæ¦œ
        <span class="link-btn" onclick="toggleSort()" id="sortHint"
          >ä¾é‡‘é¡</span
        >
      </h2>
      <div id="listStores" class="list"></div>
      <div id="emptyStores" class="empty-state" style="display: none">
        æš«ç„¡æ•¸æ“š
      </div>

      <h2>è¿‘æœŸç´€éŒ„</h2>
      <div id="loadingState" class="loading-state" style="display: none">
        â˜ï¸ æ­£åœ¨é€£ç·šåˆ° Google Sheet...
      </div>

      <div id="listRecords" class="list"></div>
      <div id="emptyRecords" class="empty-state" style="display: none">
        é»æ“Šå³ä¸‹è§’ + é–‹å§‹è¨˜éŒ„
      </div>
    </main>

    <button class="fab" id="fab">+</button>
    <div class="overlay" id="overlay"></div>

    <div class="sheet" id="sheet">
      <div class="sheet-head">
        <div class="sheet-title" id="sheetTitle">æ–°å¢ç´€éŒ„</div>
        <button class="close-btn" id="btnClose">Ã—</button>
      </div>

      <form id="form">
        <div class="form-group">
          <label class="form-label">åº—å®¶</label>
          <div class="chips" id="storeChips"></div>
          <input
            class="form-input"
            id="inpStore"
            placeholder="è¼¸å…¥åº—å®¶åç¨± (å¦‚: 50åµ)"
            required
            autocomplete="off"
          />
        </div>

        <div class="form-group">
          <label class="form-label">é£²æ–™</label>
          <div class="chips" id="drinkChips" style="display: none"></div>
          <input
            class="form-input"
            id="inpDrink"
            placeholder="è¼¸å…¥é£²æ–™åç¨± (å¦‚: 1è™Ÿ)"
            required
            autocomplete="off"
          />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">åƒ¹æ ¼</label>
            <input
              type="number"
              inputmode="numeric"
              class="form-input"
              id="inpPrice"
              placeholder="$$"
              required
            />
          </div>
          <div class="form-group">
            <label class="form-label">æ—¥æœŸ</label>
            <input type="date" class="form-input" id="inpDate" required />
          </div>
        </div>

        <button type="submit" class="btn-submit" id="btnSubmit">
          å„²å­˜åˆ°é›²ç«¯
        </button>
        <button
          type="button"
          class="btn-delete"
          id="btnDelete"
          style="display: none"
        >
          åˆªé™¤æ­¤ç­†
        </button>
      </form>
    </div>

    <script>
      // ==========================================
      // 1. è¨­å®šèˆ‡è®Šæ•¸
      // ==========================================
      // âš ï¸ é€™æ˜¯ä½ çš„ Google Apps Script ç¶²å€
      const API_URL =
        "https://script.google.com/macros/s/AKfycbxoAFfVBJsnbBHOTGkv7X8Z0SlQwfa1V6iG5nU4GDsOfoJDJgVRa-eJWczGweVHVJrc0w/exec";
      const STORAGE_KEY = "drink_diary_data";
      const STORAGE_TIMESTAMP = "drink_diary_timestamp";
      const PENDING_ACTIONS_KEY = "drink_diary_pending";

      let data = [];
      let viewRange = "week"; // week, month, all
      let sortMode = "spend"; // spend, cups
      let editId = null; // ç”¨ä¾†åˆ¤æ–·æ˜¯æ–°å¢é‚„æ˜¯ä¿®æ”¹
      let isOnline = navigator.onLine;
      let syncInProgress = false;

      const $ = (s) => document.querySelector(s);
      const $$ = (s) => document.querySelectorAll(s);

      // ==========================================
      // 2. åˆå§‹åŒ– & é›²ç«¯åŒæ­¥
      // ==========================================
      function init() {
        // é è¨­ä»Šå¤©æ—¥æœŸ
        $("#inpDate").valueAsDate = new Date();
        
        // ç›£è½ç¶²è·¯ç‹€æ…‹
        window.addEventListener("online", handleOnline);
        window.addEventListener("offline", handleOffline);
        updateOfflineBanner();
        
        // å…ˆå¾æœ¬åœ°å¿«å–è¼‰å…¥è³‡æ–™
        loadFromCache();
        
        // å•Ÿå‹•æ™‚å…ˆæŠ“è³‡æ–™
        syncData();
        
        // è¨»å†Š Service Workerï¼ˆåªåœ¨ HTTPS æˆ– localhost ç’°å¢ƒä¸‹ï¼‰
        if ("serviceWorker" in navigator && (location.protocol === "https:" || location.hostname === "localhost" || location.hostname === "127.0.0.1")) {
          navigator.serviceWorker
            .register("/sw.js")
            .then(() => console.log("SW registered"))
            .catch((e) => {
              // åªåœ¨éæœ¬åœ°æª”æ¡ˆç’°å¢ƒä¸‹é¡¯ç¤ºéŒ¯èª¤
              if (location.protocol !== "file:") {
                console.log("SW registration failed", e);
              }
            });
        }
      }

      function handleOnline() {
        isOnline = true;
        updateOfflineBanner();
        showSyncStatus("å·²æ¢å¾©é€£ç·šï¼Œæ­£åœ¨åŒæ­¥...", "syncing");
        // è™•ç†å¾…è™•ç†çš„æ“ä½œ
        processPendingActions();
        syncData();
      }

      function handleOffline() {
        isOnline = false;
        updateOfflineBanner();
        showSyncStatus("å·²é›¢ç·šï¼Œä½¿ç”¨æœ¬åœ°è³‡æ–™", "error");
      }

      function updateOfflineBanner() {
        const banner = $("#offlineBanner");
        if (isOnline) {
          banner.classList.remove("show");
        } else {
          banner.classList.add("show");
        }
      }

      function showSyncStatus(message, type = "syncing") {
        const status = $("#syncStatus");
        status.textContent = message;
        status.className = `sync-status ${type} show`;
        setTimeout(() => {
          status.classList.remove("show");
        }, 3000);
      }

      // æœ¬åœ°å¿«å–ç®¡ç†
      function saveToCache() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
          localStorage.setItem(STORAGE_TIMESTAMP, Date.now().toString());
        } catch (e) {
          console.error("å„²å­˜å¿«å–å¤±æ•—", e);
        }
      }

      function loadFromCache() {
        try {
          const cached = localStorage.getItem(STORAGE_KEY);
          const timestamp = localStorage.getItem(STORAGE_TIMESTAMP);
          
          if (cached) {
            const cachedData = JSON.parse(cached);
            // å¦‚æœå¿«å–è³‡æ–™å­˜åœ¨ä¸”ä¸è¶…é 1 å°æ™‚ï¼Œä½¿ç”¨å¿«å–
            const age = Date.now() - (parseInt(timestamp) || 0);
            if (age < 3600000) { // 1 å°æ™‚
              data = cachedData;
              render();
              console.log("å·²å¾å¿«å–è¼‰å…¥è³‡æ–™");
            }
          }
        } catch (e) {
          console.error("è¼‰å…¥å¿«å–å¤±æ•—", e);
        }
      }

      // å¾…è™•ç†æ“ä½œç®¡ç†ï¼ˆé›¢ç·šæ™‚ä½¿ç”¨ï¼‰
      function addPendingAction(action, payload) {
        try {
          const pending = JSON.parse(localStorage.getItem(PENDING_ACTIONS_KEY) || "[]");
          pending.push({ action, payload, timestamp: Date.now() });
          localStorage.setItem(PENDING_ACTIONS_KEY, JSON.stringify(pending));
        } catch (e) {
          console.error("å„²å­˜å¾…è™•ç†æ“ä½œå¤±æ•—", e);
        }
      }

      async function processPendingActions() {
        try {
          const pending = JSON.parse(localStorage.getItem(PENDING_ACTIONS_KEY) || "[]");
          if (pending.length === 0) return;

          showSyncStatus(`æ­£åœ¨è™•ç† ${pending.length} å€‹å¾…è™•ç†æ“ä½œ...`, "syncing");

          for (const item of pending) {
            try {
              const res = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ ...item.payload, action: item.action }),
              });
              const result = await res.json();
              if (!result.success) {
                throw new Error(result.error);
              }
            } catch (e) {
              console.error("è™•ç†å¾…è™•ç†æ“ä½œå¤±æ•—", e);
            }
          }

          localStorage.removeItem(PENDING_ACTIONS_KEY);
          showSyncStatus("æ‰€æœ‰å¾…è™•ç†æ“ä½œå·²å®Œæˆ", "success");
          syncData();
        } catch (e) {
          console.error("è™•ç†å¾…è™•ç†æ“ä½œæ™‚ç™¼ç”ŸéŒ¯èª¤", e);
        }
      }

      async function syncData(retryCount = 0) {
        if (syncInProgress) {
          console.log("åŒæ­¥å·²é€²è¡Œä¸­ï¼Œè·³é");
          return;
        }

        if (!isOnline) {
          showSyncStatus("é›¢ç·šä¸­ï¼Œç„¡æ³•åŒæ­¥", "error");
          return;
        }

        syncInProgress = true;
        const maxRetries = 3;
        const retryDelay = 1000 * (retryCount + 1); // éå¢å»¶é²

        // UI ç‹€æ…‹åˆ‡æ›
        if (retryCount === 0) {
          $("#loadingState").style.display = "block";
          $("#listRecords").style.display = "none";
          $("#listStores").style.display = "none";
          $("#emptyRecords").style.display = "none";
        }
        $("#btnSync").innerText = "â³";
        showSyncStatus("æ­£åœ¨åŒæ­¥è³‡æ–™...", "syncing");

        try {
          console.log("é–‹å§‹åŒæ­¥ï¼ŒAPI URL:", API_URL);
          
          // ä½¿ç”¨ timeout é¿å…é•·æ™‚é–“ç­‰å¾…
          const controller = new AbortController();
          const timeoutId = setTimeout(() => {
            if (controller && controller.signal) {
              controller.abort();
            }
          }, 15000); // 15 ç§’è¶…æ™‚

          const fetchOptions = {
            method: "GET",
          };
          
          // åªæœ‰åœ¨ controller å’Œ signal å­˜åœ¨æ™‚æ‰æ·»åŠ 
          if (controller && controller.signal) {
            fetchOptions.signal = controller.signal;
          }

          const res = await fetch(API_URL + "?t=" + Date.now(), fetchOptions);
          clearTimeout(timeoutId);

          console.log("API å›æ‡‰ç‹€æ…‹:", res.status, res.statusText);

          if (!res.ok) {
            const errorText = await res.text().catch(() => "");
            console.error("API éŒ¯èª¤å›æ‡‰:", errorText);
            throw new Error(`HTTP ${res.status}: ${res.statusText}. ${errorText.substring(0, 100)}`);
          }

          const rows = await res.json();
          console.log("æ”¶åˆ°è³‡æ–™:", rows.length, "ç­†");

          if (!Array.isArray(rows)) {
            console.error("è³‡æ–™ä¸æ˜¯é™£åˆ—:", typeof rows, rows);
            throw new Error("è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼šé æœŸé™£åˆ—ä½†æ”¶åˆ° " + typeof rows);
          }

          // è³‡æ–™è½‰æ›ï¼š[date, store, item, price, id] -> Object
          const newData = rows.map((r) => {
            if (!Array.isArray(r)) {
              return null;
            }
            return {
              date: formatDate(r[0]),
              store: r[1] || "",
              drink: r[2] || "",
              price: Number(r[3]) || 0,
              id: r[4] || `ID${Date.now()}_${Math.random()}`,
            };
          }).filter(r => r !== null && r.id);

          console.log("è½‰æ›å¾Œè³‡æ–™:", newData.length, "ç­†");

          // åˆä½µè³‡æ–™ï¼ˆè™•ç†è¡çªï¼‰
          data = mergeData(data, newData);
          saveToCache(); // å„²å­˜åˆ°æœ¬åœ°å¿«å–

          render(); // æŠ“å®Œè³‡æ–™å¾Œé‡æ–°æ¸²æŸ“ç•«é¢
          showSyncStatus(`åŒæ­¥æˆåŠŸï¼è¼‰å…¥ ${newData.length} ç­†è³‡æ–™`, "success");
        } catch (e) {
          console.error("åŒæ­¥å¤±æ•—", e);
          const errorMsg = e.message || e.toString();
          
          // é¡¯ç¤ºè©³ç´°éŒ¯èª¤
          let userMsg = "åŒæ­¥å¤±æ•—";
          let debugInfo = "";
          
          if (errorMsg.includes("Failed to fetch") || errorMsg.includes("NetworkError") || errorMsg.includes("fetch")) {
            userMsg = "ç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨";
            debugInfo = `å¯èƒ½åŸå› ï¼š
1. Google Apps Script æœªæ­£ç¢ºéƒ¨ç½²
2. API ç¶²å€ä¸æ­£ç¢º
3. ç¶²è·¯é€£ç·šå•é¡Œ
4. CORS è¨­å®šéŒ¯èª¤

è«‹æª¢æŸ¥ï¼š
- Apps Script æ˜¯å¦å·²éƒ¨ç½²ç‚ºã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ã€
- æ˜¯å¦è¨­å®šã€Œä»»ä½•äººã€å¯å­˜å–
- API ç¶²å€æ˜¯å¦æ­£ç¢ºï¼š${API_URL}`;
          } else if (errorMsg.includes("aborted")) {
            userMsg = "è«‹æ±‚è¶…æ™‚ï¼Œè«‹ç¨å¾Œå†è©¦";
          } else if (errorMsg.includes("CORS")) {
            userMsg = "CORS éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ Apps Script éƒ¨ç½²è¨­å®š";
            debugInfo = "è«‹ç¢ºèª Apps Script éƒ¨ç½²æ™‚é¸æ“‡ã€Œä»»ä½•äººã€å¯å­˜å–";
          } else {
            userMsg = `åŒæ­¥å¤±æ•—ï¼š${errorMsg.substring(0, 50)}`;
          }
          
          // åœ¨ Console é¡¯ç¤ºè©³ç´°è³‡è¨Š
          console.error("è©³ç´°éŒ¯èª¤è³‡è¨Š:", {
            error: e,
            message: errorMsg,
            API_URL: API_URL,
            isOnline: isOnline,
            debugInfo: debugInfo
          });
          
          // é‡è©¦æ©Ÿåˆ¶
          if (retryCount < maxRetries && isOnline) {
            showSyncStatus(`${userMsg}ï¼Œ${retryDelay / 1000} ç§’å¾Œé‡è©¦...`, "error");
            setTimeout(() => {
              syncData(retryCount + 1);
            }, retryDelay);
            return;
          }

          // å¦‚æœæ‰€æœ‰é‡è©¦éƒ½å¤±æ•—ï¼Œä½¿ç”¨å¿«å–è³‡æ–™
          if (data.length === 0) {
            loadFromCache();
            showSyncStatus("ä½¿ç”¨æœ¬åœ°å¿«å–è³‡æ–™", "syncing");
          } else {
            showSyncStatus(userMsg + "ï¼ˆä½¿ç”¨æœ¬åœ°è³‡æ–™ï¼‰", "error");
          }
          
          // é¡¯ç¤ºè©³ç´°éŒ¯èª¤çµ¦é–‹ç™¼è€…
          if (retryCount === 0) {
            console.error("å®Œæ•´éŒ¯èª¤è³‡è¨Š:", {
              message: e.message,
              stack: e.stack,
              API_URL: API_URL,
              isOnline: isOnline,
              errorType: e.name,
              errorDetails: e
            });
            
            // å˜—è©¦ç›´æ¥æ¸¬è©¦ API URL
            testAPIURL();
          }
        } finally {
          $("#loadingState").style.display = "none";
          $("#listRecords").style.display = "flex";
          $("#listStores").style.display = "flex";
          $("#btnSync").innerText = "ğŸ”„ åŒæ­¥";
          syncInProgress = false;
        }
      }

      // åˆä½µè³‡æ–™ï¼ˆè™•ç†å¤šè£ç½®åŒæ­¥è¡çªï¼‰
      function mergeData(localData, remoteData) {
        const merged = [...remoteData];
        const remoteIds = new Set(remoteData.map((d) => d.id));

        // ä¿ç•™æœ¬åœ°æœ‰ä½†é ç«¯æ²’æœ‰çš„è³‡æ–™ï¼ˆå¯èƒ½æ˜¯å¾…åŒæ­¥çš„ï¼‰
        localData.forEach((local) => {
          if (!remoteIds.has(local.id)) {
            // æª¢æŸ¥æ˜¯å¦ç‚ºå¾…è™•ç†çš„æ“ä½œ
            const pending = JSON.parse(localStorage.getItem(PENDING_ACTIONS_KEY) || "[]");
            const isPending = pending.some(
              (p) => p.payload.id === local.id || p.payload.id === local.id.replace("ID", "")
            );
            if (!isPending) {
              merged.push(local);
            }
          }
        });

        // æŒ‰æ—¥æœŸæ’åº
        merged.sort((a, b) => new Date(b.date) - new Date(a.date));
        return merged;
      }

      // ==========================================
      // 3. è³‡æ–™æ“ä½œ (CRUD)
      // ==========================================
      async function handleSubmit(e) {
        e.preventDefault();

        // è³‡æ–™é©—è­‰
        const store = $("#inpStore").value.trim();
        const drink = $("#inpDrink").value.trim();
        const price = parseFloat($("#inpPrice").value);
        const date = $("#inpDate").value;

        if (!store || !drink) {
          alert("è«‹å¡«å¯«åº—å®¶åç¨±å’Œé£²æ–™åç¨±");
          return;
        }

        if (isNaN(price) || price <= 0) {
          alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„åƒ¹æ ¼");
          return;
        }

        if (!date) {
          alert("è«‹é¸æ“‡æ—¥æœŸ");
          return;
        }

        const btn = $("#btnSubmit");
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = isOnline ? "â˜ï¸ é›²ç«¯è™•ç†ä¸­..." : "ğŸ’¾ å„²å­˜ä¸­...";

        // åˆ¤æ–·å‹•ä½œ
        const action = editId ? "edit" : "add";
        // å¦‚æœæ˜¯æ–°å¢ï¼Œç”¢ç”Ÿä¸€å€‹éš¨æ©Ÿ ID
        const id = editId ? editId : "ID" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);

        const payload = {
          action: action,
          id: id,
          store: store,
          item: drink, // å°æ‡‰ GAS è®Šæ•¸
          price: price,
          date: date,
        };

        // æ¨‚è§€æ›´æ–°ï¼šå…ˆæ›´æ–°æœ¬åœ°è³‡æ–™
        const newItem = {
          id: id,
          store: store,
          drink: drink,
          price: price,
          date: date,
        };

        if (editId) {
          // ç·¨è¼¯æ¨¡å¼
          const index = data.findIndex((d) => d.id === editId);
          if (index !== -1) {
            data[index] = newItem;
          }
        } else {
          // æ–°å¢æ¨¡å¼
          data.unshift(newItem);
        }
        saveToCache();
        render();

        if (isOnline) {
          try {
            // å‚³é€çµ¦ Google Apps Script
            console.log("ç™¼é€è³‡æ–™:", payload);
            const controller = new AbortController();
            const timeoutId = setTimeout(() => {
              if (controller && controller.signal) {
                controller.abort();
              }
            }, 10000);

            const fetchOptions = {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            };
            
            if (controller && controller.signal) {
              fetchOptions.signal = controller.signal;
            }

            const res = await fetch(API_URL, fetchOptions);
            clearTimeout(timeoutId);

            if (!res.ok) {
              throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            }

            const result = await res.json();
            console.log("ä¸Šå‚³å›æ‡‰:", result);

            if (!result.success) {
              throw new Error(result.error || "æ“ä½œå¤±æ•—");
            }

            showSyncStatus(editId ? "ä¿®æ”¹æˆåŠŸï¼" : "æ–°å¢æˆåŠŸï¼", "success");
            closeSheet();
            // èƒŒæ™¯åŒæ­¥ç¢ºä¿è³‡æ–™æ­£ç¢º
            setTimeout(() => syncData(), 1000);
          } catch (e) {
            console.error("ä¸Šå‚³å¤±æ•—", e);
            // å¦‚æœä¸Šå‚³å¤±æ•—ï¼Œå°‡æ“ä½œåŠ å…¥å¾…è™•ç†åˆ—è¡¨
            addPendingAction(action, payload);
            showSyncStatus("å·²å„²å­˜åˆ°æœ¬åœ°ï¼Œå°‡åœ¨é€£ç·šå¾Œè‡ªå‹•åŒæ­¥", "syncing");
            closeSheet();
            // ä»ç„¶å˜—è©¦èƒŒæ™¯åŒæ­¥
            setTimeout(() => syncData(), 2000);
          }
        } else {
          // é›¢ç·šæ¨¡å¼ï¼šåŠ å…¥å¾…è™•ç†åˆ—è¡¨
          addPendingAction(action, payload);
          showSyncStatus("å·²å„²å­˜ï¼Œå°‡åœ¨é€£ç·šå¾Œè‡ªå‹•åŒæ­¥", "syncing");
          closeSheet();
        }

        btn.disabled = false;
        btn.innerText = originalText;
      }

      async function deleteRecord() {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ(ç„¡æ³•å¾©åŸ)")) return;

        const btn = $("#btnDelete");
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = isOnline ? "åˆªé™¤ä¸­..." : "æ¨™è¨˜åˆªé™¤...";

        // æ¨‚è§€æ›´æ–°ï¼šå…ˆå¾æœ¬åœ°ç§»é™¤
        data = data.filter((d) => d.id !== editId);
        saveToCache();
        render();

        const payload = { action: "delete", id: editId };

        if (isOnline) {
          try {
            console.log("åˆªé™¤è³‡æ–™:", payload);
            const controller = new AbortController();
            const timeoutId = setTimeout(() => {
              if (controller && controller.signal) {
                controller.abort();
              }
            }, 10000);

            const fetchOptions = {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            };
            
            if (controller && controller.signal) {
              fetchOptions.signal = controller.signal;
            }

            const res = await fetch(API_URL, fetchOptions);
            clearTimeout(timeoutId);

            if (!res.ok) {
              throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            }

            const result = await res.json();
            console.log("åˆªé™¤å›æ‡‰:", result);

            if (!result.success) {
              throw new Error(result.error || "åˆªé™¤å¤±æ•—");
            }

            showSyncStatus("å·²åˆªé™¤", "success");
            closeSheet();
            setTimeout(() => syncData(), 1000);
          } catch (e) {
            console.error("åˆªé™¤å¤±æ•—", e);
            addPendingAction("delete", payload);
            showSyncStatus("å·²æ¨™è¨˜åˆªé™¤ï¼Œå°‡åœ¨é€£ç·šå¾ŒåŒæ­¥", "syncing");
            closeSheet();
            setTimeout(() => syncData(), 2000);
          }
        } else {
          addPendingAction("delete", payload);
          showSyncStatus("å·²æ¨™è¨˜åˆªé™¤ï¼Œå°‡åœ¨é€£ç·šå¾ŒåŒæ­¥", "syncing");
          closeSheet();
        }

        btn.disabled = false;
        btn.innerText = originalText;
      }

      // ==========================================
      // 4. ç•«é¢æ¸²æŸ“é‚è¼¯ (é€™éƒ¨åˆ†æ²¿ç”¨ä½ åŸæœ¬çš„ç²¾ç¾ UI)
      // ==========================================
      function render() {
        const subData = getFilteredData();

        // 1. çµ±è¨ˆæ•¸å­—
        const totalCups = subData.length;
        const totalSpend = subData.reduce((a, b) => a + Number(b.price), 0);
        $("#valCups").innerText = totalCups;
        $("#valSpend").innerText = fmtMoney(totalSpend);

        // 2. ç´€éŒ„åˆ—è¡¨
        const list = $("#listRecords");
        list.innerHTML = "";

        if (subData.length === 0) {
          $("#emptyRecords").style.display = "block";
        } else {
          $("#emptyRecords").style.display = "none";
          // æ’åºï¼šæ—¥æœŸæ–°çš„åœ¨ä¸Šé¢
          const sorted = [...subData].sort(
            (a, b) => new Date(b.date) - new Date(a.date)
          );

          sorted.forEach((item) => {
            const div = document.createElement("div");
            div.className = "item";
            div.onclick = () => openSheet(item); // é»æ“Šç·¨è¼¯
            div.innerHTML = `
              <div class="item-main">
                <div class="item-title">${item.store}</div>
                <div class="item-sub">${item.drink}</div>
              </div>
              <div class="item-right">
                <div class="item-price">${fmtMoney(item.price)}</div>
                <div class="item-tag">${item.date
                  .slice(5)
                  .replace("-", "/")}</div>
              </div>
            `;
            list.appendChild(div);
          });
        }

        // 3. åº—å®¶æ’è¡Œæ¦œ
        const storeMap = {};
        subData.forEach((i) => {
          if (!storeMap[i.store])
            storeMap[i.store] = { name: i.store, cups: 0, spend: 0 };
          storeMap[i.store].cups += 1;
          storeMap[i.store].spend += Number(i.price);
        });
        let stores = Object.values(storeMap);

        // æ’åºé‚è¼¯
        stores.sort((a, b) =>
          sortMode === "spend" ? b.spend - a.spend : b.cups - a.cups
        );

        const storeList = $("#listStores");
        storeList.innerHTML = "";
        if (stores.length === 0) {
          $("#emptyStores").style.display = "block";
        } else {
          $("#emptyStores").style.display = "none";
          stores.forEach((s) => {
            const div = document.createElement("div");
            div.className = "item";
            div.style.cursor = "default"; // æ’è¡Œæ¦œä¸èƒ½é»
            div.innerHTML = `
              <div class="item-main">
                <div class="item-title">${s.name}</div>
                <div class="item-sub">${s.cups} æ¯</div>
              </div>
              <div class="item-right">
                <div class="item-price">${fmtMoney(s.spend)}</div>
              </div>
            `;
            storeList.appendChild(div);
          });
        }
      }

      // ==========================================
      // 5. è¼”åŠ©åŠŸèƒ½
      // ==========================================
      const fmtMoney = (n) => `$${n}`;

      const getStartOfWeek = () => {
        const d = new Date();
        const day = d.getDay() || 7;
        d.setHours(0, 0, 0, 0);
        d.setDate(d.getDate() - day + 1);
        return d;
      };

      const getStartOfMonth = () => {
        const d = new Date();
        d.setHours(0, 0, 0, 0);
        d.setDate(1);
        return d;
      };

      function getFilteredData() {
        const now = new Date();
        let limit = 0;
        if (viewRange === "week") limit = getStartOfWeek().getTime();
        if (viewRange === "month") limit = getStartOfMonth().getTime();
        return data.filter((d) => new Date(d.date).getTime() >= limit);
      }

      function formatDate(dateVal) {
        if (!dateVal) return "";
        const d = new Date(dateVal);
        const offset = d.getTimezoneOffset() * 60000;
        return new Date(d - offset).toISOString().slice(0, 10);
      }

      function setRange(r) {
        viewRange = r;
        $$(".segment button").forEach((b) => b.classList.remove("active"));
        $(`#tab-${r}`).classList.add("active");
        render();
      }

      function toggleSort() {
        sortMode = sortMode === "spend" ? "cups" : "spend";
        $("#sortHint").innerText = sortMode === "spend" ? "ä¾é‡‘é¡" : "ä¾æ¯æ•¸";
        render();
      }

      // ==========================================
      // 6. UI äº’å‹• (Sheet & Suggestion)
      // ==========================================
      function openSheet(item = null) {
        $("#overlay").classList.add("show");
        $("#sheet").classList.add("show");

        renderStoreSuggestions();
        $("#drinkChips").style.display = "none";

        if (item) {
          // ç·¨è¼¯æ¨¡å¼
          editId = item.id;
          $("#sheetTitle").innerText = "ç·¨è¼¯ç´€éŒ„";
          $("#inpStore").value = item.store;
          $("#inpDrink").value = item.drink;
          $("#inpPrice").value = item.price;
          $("#inpDate").value = item.date;
          $("#btnSubmit").innerText = "æ›´æ–°ç´€éŒ„";
          $("#btnDelete").style.display = "block";
        } else {
          // æ–°å¢æ¨¡å¼
          editId = null;
          $("#sheetTitle").innerText = "æ–°å¢ç´€éŒ„";
          $("#inpStore").value = "";
          $("#inpDrink").value = "";
          $("#inpPrice").value = "";
          $("#inpDate").valueAsDate = new Date();
          $("#btnSubmit").innerText = "å„²å­˜åˆ°é›²ç«¯";
          $("#btnDelete").style.display = "none";
          $("#inpStore").focus();
        }
      }

      function closeSheet() {
        $("#overlay").classList.remove("show");
        $("#sheet").classList.remove("show");
        $("#inpStore").blur();
      }

      function renderStoreSuggestions() {
        const count = {};
        data.forEach((x) => (count[x.store] = (count[x.store] || 0) + 1));
        const topStores = Object.keys(count)
          .sort((a, b) => count[b] - count[a])
          .slice(0, 5);

        const box = $("#storeChips");
        box.innerHTML = "";
        topStores.forEach((s) => {
          const chip = document.createElement("div");
          chip.className = "chip";
          chip.innerText = s;
          chip.onclick = () => {
            $("#inpStore").value = s;
            renderDrinkSuggestions(s);
          };
          box.appendChild(chip);
        });
      }

      function renderDrinkSuggestions(storeName) {
        const drinks = data
          .filter((x) => x.store === storeName)
          .map((x) => x.drink);
        const count = {};
        drinks.forEach((d) => (count[d] = (count[d] || 0) + 1));
        const topDrinks = Object.keys(count)
          .sort((a, b) => count[b] - count[a])
          .slice(0, 5);

        const box = $("#drinkChips");
        if (topDrinks.length > 0) {
          box.style.display = "flex";
          box.innerHTML = "";
          topDrinks.forEach((d) => {
            const chip = document.createElement("div");
            chip.className = "chip";
            chip.innerText = d;
            chip.onclick = () => {
              $("#inpDrink").value = d;
              // è‡ªå‹•å¸¶å…¥ä¸Šæ¬¡åƒ¹æ ¼
              const last = data.find(
                (x) => x.store === storeName && x.drink === d
              );
              if (last) $("#inpPrice").value = last.price;
            };
            box.appendChild(chip);
          });
        } else {
          box.style.display = "none";
        }
      }

      $("#inpStore").addEventListener("blur", (e) => {
        if (e.target.value) renderDrinkSuggestions(e.target.value);
      });

      // ==========================================
      // 7. äº‹ä»¶ç›£è½
      // ==========================================
      $("#fab").onclick = () => openSheet();
      $("#overlay").onclick = closeSheet;
      $("#btnClose").onclick = closeSheet;
      $("#form").onsubmit = handleSubmit;
      $("#btnDelete").onclick = deleteRecord;

      // ==========================================
      // 8. é™¤éŒ¯å·¥å…·
      // ==========================================
      function toggleDebug() {
        const panel = $("#debugPanel");
        panel.classList.toggle("show");
        if (panel.classList.contains("show")) {
          updateDebugInfo();
        }
      }

      function updateDebugInfo() {
        const content = $("#debugContent");
        const pending = JSON.parse(localStorage.getItem(PENDING_ACTIONS_KEY) || "[]");
        
        content.innerHTML = `
          <div class="debug-item">
            <span class="debug-label">API URL:</span>
            <div class="debug-value" style="word-break: break-all;">${API_URL}</div>
          </div>
          <div class="debug-item">
            <span class="debug-label">é€£ç·šç‹€æ…‹:</span>
            <span class="debug-value">${isOnline ? "âœ… ç·šä¸Š" : "âŒ é›¢ç·š"}</span>
          </div>
          <div class="debug-item">
            <span class="debug-label">åŒæ­¥ä¸­:</span>
            <span class="debug-value">${syncInProgress ? "â³ æ˜¯" : "âœ… å¦"}</span>
          </div>
          <div class="debug-item">
            <span class="debug-label">æœ¬åœ°è³‡æ–™:</span>
            <span class="debug-value">${data.length} ç­†</span>
          </div>
          <div class="debug-item">
            <span class="debug-label">å¾…è™•ç†æ“ä½œ:</span>
            <span class="debug-value">${pending.length} å€‹</span>
          </div>
          <div class="debug-item">
            <span class="debug-label">å¿«å–æ™‚é–“:</span>
            <span class="debug-value">${localStorage.getItem(STORAGE_TIMESTAMP) ? new Date(parseInt(localStorage.getItem(STORAGE_TIMESTAMP))).toLocaleString() : "ç„¡"}</span>
          </div>
          <div class="debug-item" style="margin-top: 8px;">
            <button onclick="testAPI()" style="background: #007aff; color: #fff; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px;">
              æ¸¬è©¦ API é€£ç·š
            </button>
            <button onclick="clearCache()" style="background: #ff3b30; color: #fff; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; margin-left: 8px;">
              æ¸…é™¤å¿«å–
            </button>
          </div>
        `;
      }

      async function testAPI() {
        const content = $("#debugContent");
        const testDiv = document.createElement("div");
        testDiv.className = "debug-item";
        testDiv.innerHTML = '<span class="debug-label">æ¸¬è©¦ä¸­...</span>';
        content.appendChild(testDiv);

        try {
          console.log("æ¸¬è©¦ API URL:", API_URL);
          const startTime = Date.now();
          
          // å…ˆæ¸¬è©¦åŸºæœ¬é€£ç·š
          const res = await fetch(API_URL + "?t=" + Date.now(), {
            method: "GET",
            cache: "no-cache",
            mode: "cors",
          });
          const endTime = Date.now();
          const duration = endTime - startTime;

          console.log("API å›æ‡‰:", res.status, res.statusText);

          if (res.ok) {
            const contentType = res.headers.get("content-type");
            console.log("Content-Type:", contentType);
            
            if (contentType && contentType.includes("application/json")) {
              const data = await res.json();
              testDiv.innerHTML = `
                <span class="debug-label">âœ… API æ¸¬è©¦æˆåŠŸ</span>
                <div class="debug-value">ç‹€æ…‹: ${res.status}</div>
                <div class="debug-value">å›æ‡‰æ™‚é–“: ${duration}ms</div>
                <div class="debug-value">è³‡æ–™ç­†æ•¸: ${Array.isArray(data) ? data.length : "æ ¼å¼éŒ¯èª¤"}</div>
                <div class="debug-value">Content-Type: ${contentType}</div>
              `;
            } else {
              const text = await res.text();
              testDiv.innerHTML = `
                <span class="debug-label debug-error">âš ï¸ å›æ‡‰æ ¼å¼éŒ¯èª¤</span>
                <div class="debug-value">ç‹€æ…‹: ${res.status}</div>
                <div class="debug-value">Content-Type: ${contentType || "æœªçŸ¥"}</div>
                <div class="debug-value">å›æ‡‰å…§å®¹: ${text.substring(0, 100)}</div>
              `;
            }
          } else {
            const errorText = await res.text().catch(() => "");
            testDiv.innerHTML = `
              <span class="debug-label debug-error">âŒ API æ¸¬è©¦å¤±æ•—</span>
              <div class="debug-value">ç‹€æ…‹: ${res.status} ${res.statusText}</div>
              <div class="debug-value">éŒ¯èª¤å…§å®¹: ${errorText.substring(0, 200)}</div>
            `;
          }
        } catch (e) {
          console.error("API æ¸¬è©¦éŒ¯èª¤:", e);
          let errorDetails = e.message;
          if (e.message.includes("Failed to fetch") || e.message.includes("fetch")) {
            errorDetails = `ç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨
å¯èƒ½åŸå› ï¼š
1. Google Apps Script æœªæ­£ç¢ºéƒ¨ç½²
2. API ç¶²å€ä¸æ­£ç¢º: ${API_URL}
3. CORS è¨­å®šéŒ¯èª¤ï¼ˆéœ€è¨­å®šã€Œä»»ä½•äººã€å¯å­˜å–ï¼‰
4. ç¶²è·¯é€£ç·šå•é¡Œ`;
          }
          testDiv.innerHTML = `
            <span class="debug-label debug-error">âŒ API æ¸¬è©¦å¤±æ•—</span>
            <div class="debug-value" style="white-space: pre-wrap; font-size: 10px;">${errorDetails}</div>
          `;
        }
        updateDebugInfo();
      }

      // è‡ªå‹•æ¸¬è©¦ API URLï¼ˆç•¶åŒæ­¥å¤±æ•—æ™‚ï¼‰
      async function testAPIURL() {
        try {
          console.log("è‡ªå‹•æ¸¬è©¦ API URL...");
          const res = await fetch(API_URL, {
            method: "GET",
            mode: "cors",
          });
          console.log("API æ¸¬è©¦çµæœ:", res.status, res.statusText);
        } catch (e) {
          console.error("API URL æ¸¬è©¦å¤±æ•—:", e);
          console.error("è«‹ç¢ºèªï¼š");
          console.error("1. Google Apps Script å·²éƒ¨ç½²ç‚ºã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ã€");
          console.error("2. éƒ¨ç½²æ™‚é¸æ“‡ã€Œä»»ä½•äººã€å¯å­˜å–");
          console.error("3. API URL æ­£ç¢º:", API_URL);
        }
      }

      function clearCache() {
        if (confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æœ¬åœ°å¿«å–å—ï¼Ÿ")) {
          localStorage.removeItem(STORAGE_KEY);
          localStorage.removeItem(STORAGE_TIMESTAMP);
          localStorage.removeItem(PENDING_ACTIONS_KEY);
          data = [];
          render();
          updateDebugInfo();
          alert("å¿«å–å·²æ¸…é™¤");
        }
      }

      // å®šæœŸæ›´æ–°é™¤éŒ¯è³‡è¨Š
      setInterval(() => {
        if ($("#debugPanel").classList.contains("show")) {
          updateDebugInfo();
        }
      }, 2000);

      // å•Ÿå‹•ï¼
      init();
    </script>
  </body>
</html>
